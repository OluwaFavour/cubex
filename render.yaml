# ============================================================================
# Render Blueprint for CubeX Application
# ============================================================================
# Auto-deploy configuration for the FastAPI application
#
# Triggers deployment on changes to:
#   - app/ folder (application code)
#   - migrations/ folder (database migrations)
# ============================================================================

services:
  - type: web
    name: cubex-api
    runtime: docker
    dockerfilePath: ./Dockerfile
    dockerContext: .
    plan: free
    region: oregon

    # Docker command to run
    dockerCommand: uvicorn app.main:app --host 0.0.0.0 --port 8000

    # Auto-deploy on push
    autoDeploy: true

    # Pre-deploy: install requirements and run migrations
    preDeployCommand: pip install -r requirements.txt && alembic upgrade head

    # Health check configuration
    healthCheckPath: /health

    # Environment variables (set these in Render dashboard)
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: PORT
        value: "8000"
      - key: DEBUG
        value: "false"
      - key: DATABASE_URL
        sync: false  # Set manually in dashboard
      - key: SESSION_SECRET_KEY
        generateValue: true
      - key: JWT_SECRET_KEY
        generateValue: true
      - key: OTP_HMAC_SECRET
        generateValue: true
      - key: INTERNAL_API_SECRET
        generateValue: true
      - key: ADMIN_PASSWORD
        generateValue: true
      - key: REDIS_URL
        sync: false  # Set manually in dashboard
      - key: RABBITMQ_URL
        sync: false  # Set manually in dashboard
      - key: SENTRY_DSN
        sync: false  # Optional: Set in dashboard
      - key: SENTRY_TRACES_SAMPLE_RATE
        value: "0.1"
      - key: STRIPE_API_KEY
        sync: false  # Set manually in dashboard
      - key: STRIPE_WEBHOOK_SECRET
        sync: false  # Set manually in dashboard
      - key: BREVO_API_KEY
        sync: false  # Set manually in dashboard
      - key: GOOGLE_CLIENT_ID
        sync: false  # Set manually in dashboard
      - key: GOOGLE_CLIENT_SECRET
        sync: false  # Set manually in dashboard
      - key: GITHUB_CLIENT_ID
        sync: false  # Set manually in dashboard
      - key: GITHUB_CLIENT_SECRET
        sync: false  # Set manually in dashboard

  # --------------------------------------------------------------------------
  # Worker - RabbitMQ Message Consumer (processes Stripe webhooks, etc.)
  # --------------------------------------------------------------------------
  - type: worker
    name: cubex-worker
    runtime: docker
    dockerfilePath: ./Dockerfile
    dockerContext: .
    plan: starter
    region: oregon
    autoDeploy: true
    dockerCommand: python -m app.infrastructure.messaging.main
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: DATABASE_URL
        fromService:
          name: cubex-api
          type: web
          envVarKey: DATABASE_URL
      - key: REDIS_URL
        fromService:
          name: cubex-api
          type: web
          envVarKey: REDIS_URL
      - key: RABBITMQ_URL
        fromService:
          name: cubex-api
          type: web
          envVarKey: RABBITMQ_URL
      - key: STRIPE_API_KEY
        fromService:
          name: cubex-api
          type: web
          envVarKey: STRIPE_API_KEY
      - key: BREVO_API_KEY
        fromService:
          name: cubex-api
          type: web
          envVarKey: BREVO_API_KEY
      - key: ENABLE_SCHEDULER
        value: "false"
      - key: ENABLE_MESSAGING
        value: "true"

  # --------------------------------------------------------------------------
  # Scheduler - APScheduler Background Jobs (cleanup, usage log expiry)
  # --------------------------------------------------------------------------
  - type: worker
    name: cubex-scheduler
    runtime: docker
    dockerfilePath: ./Dockerfile
    dockerContext: .
    plan: starter
    region: oregon
    autoDeploy: true
    dockerCommand: python -m app.infrastructure.scheduler.main
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: DATABASE_URL
        fromService:
          name: cubex-api
          type: web
          envVarKey: DATABASE_URL
      - key: REDIS_URL
        fromService:
          name: cubex-api
          type: web
          envVarKey: REDIS_URL
      - key: BREVO_API_KEY
        fromService:
          name: cubex-api
          type: web
          envVarKey: BREVO_API_KEY
      - key: ENABLE_SCHEDULER
        value: "true"
      - key: ENABLE_MESSAGING
        value: "false"

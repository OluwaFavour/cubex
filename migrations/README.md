# Database Migrations

Alembic-managed migrations for the CueBX PostgreSQL database.

## Quick Reference

```bash
# Apply all pending migrations
python manage.py migrate

# Generate a new migration from model changes
python manage.py makemigrations "add user avatar field"

# View migration history
python manage.py showmigrations

# Reset Alembic version tracking (dangerous — use only in development)
python manage.py clearalembic
```

## How Migrations Work

1. **Models** are defined in `app/core/db/models/` and `app/apps/*/db/models/`
2. **Alembic autogenerate** compares the models against the current DB schema
3. A new migration file is generated in `migrations/versions/`
4. `alembic upgrade head` applies all pending migrations to the database

## Creating a Migration

```bash
# After changing a model, generate the migration:
python manage.py makemigrations "describe what changed"

# Always review the generated file before applying:
# migrations/versions/<hash>_describe_what_changed.py

# Apply it:
python manage.py migrate
```

### What to check in the generated migration

- **Correct table/column names** — autogenerate sometimes misses renames (it creates a drop + add instead)
- **Default values** — ensure `server_default` is set for columns that need DB-level defaults
- **Indexes and constraints** — verify they have descriptive names matching our convention: `ix_<table>_<column>`, `uq_<table>_<column>`, `ck_<table>_<description>`
- **Data migrations** — if you need to backfill data, add a separate file with raw SQL or session operations (don't mix schema + data in one migration)

### Naming conventions

| Object | Convention | Example |
| -------- | ----------- | --------- |
| Index | `ix_<table>_<columns>` | `ix_users_email` |
| Unique constraint | `uq_<table>_<columns>` | `uq_plans_name_product_type` |
| Check constraint | `ck_<table>_<description>` | `ck_plans_price_non_negative` |
| Foreign key | `fk_<table>_<column>_<ref_table>` | auto-generated by SQLAlchemy |

## PostgreSQL Extensions

Some models require PostgreSQL extensions. Ensure they exist before running migrations:

```bash
python manage.py createextensions citext uuid-ossp
```

## Deployment

- **Render**: The pre-deploy command runs `alembic upgrade head` automatically
- **Docker**: Run `docker compose run --rm api alembic upgrade head`
- **CI**: GitHub Actions workflow runs migrations before tests

## Common Issues

### "Target database is not up to date"

Run `python manage.py migrate` to apply pending migrations.

### "Can't autogenerate — no changes detected"

Ensure your model file is imported in the relevant app's `db/models/__init__.py` (for app-specific models like `Workspace`, `CareerUsageLog`) or `app/core/db/models/__init__.py` (for shared core models). App-specific models live in their respective `app/apps/*/db/models/` packages and are not re-exported from core. Alembic only sees models that are imported when it runs.

### Migration conflicts after rebasing

If two branches both generated a migration, you'll get a "multiple heads" error. Fix with:

```bash
# Show current heads
alembic heads

# Merge the heads into a single migration
alembic merge heads -m "merge migrations"

# Apply
python manage.py migrate
```
